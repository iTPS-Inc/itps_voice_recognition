#!/usr/bin/env python3
#!/usr/bin/env python3
from fastai.data.all import untar_data, Path
from fastai.data.transforms import RandomSplitter
import pandas as pd
import shutil, os
from dsets.helpers.helpers import make_tarfile, train_test_split

LJ_SPEECH_URL_ORIG = "https://www.dropbox.com/s/cwq264n040guqhj/LJSpeech-1.1.tar.bz2?dl=1"
OUTPATH = "/home/jjs/Dropbox/Share to iTPS AI-Team/train_data_repository/LJSpeech-1.1.tar.gz"
FORCE_DOWNLOAD=True

def get_ljl_data_init(force_download=False):
    p = untar_data(LJ_SPEECH_URL_ORIG, force_download=force_download)
    df = pd.read_csv(p / "metadata.csv", sep="|", header=None)
    df[0] = df[0].apply(lambda x: p / "wavs" / (x + ".wav"))
    df = df.rename({0: "filename", 1: "text (numbers)", 2: "text"}, axis="columns")
    return p, df


p, df = get_ljl_data_init(force_download=FORCE_DOWNLOAD)
df = train_test_split(df)

os.mkdir(p / "wavs" / "train")
os.mkdir(p / "wavs" / "test")

for i, r in df.iterrows():
    if r["test"]:
        src = r["filename"]
        dest = r["filename"].parent / "test" / r["filename"].name
        shutil.move(src, dest)
    elif not r["test"]:
        src = r["filename"]
        dest = r["filename"].parent / "train" / r["filename"].name
        shutil.move(src, dest)

df["filename"] = df.apply(
    lambda r: Path("wavs") / "test" / r["filename"].name
    if r["test"]
    else Path("wavs") / "train" / r["filename"].name
    ,axis=1
)

df.to_csv( p / "metadata.csv")
make_tarfile(OUTPATH, p)
